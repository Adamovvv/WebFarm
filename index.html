<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–µ—Ä–º–µ—Ä—Å–∫–∏–π –º–∞–≥–Ω–∞—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            overflow: hidden; /* –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        }
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
        }
        .dark {
            --bg-color: #000000;
            --text-color: #ffffff;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #header {
            padding: 10px;
            background-color: var(--header-bg);
            color: var(--header-text);
        }
        .tab-content {
            flex: 1;
            overflow: auto;
            padding: 10px;
        }
        .bottom-bar {
            display: flex;
            justify-content: space-around;
            background-color: var(--bottom-bar-bg);
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* –£—á–∏—Ç—ã–≤–∞–µ–º safe-area */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        .bottom-bar button {
            padding: 10px;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            cursor: pointer;
        }
        #clicker {
            width: 100px;
            height: 100px;
            background-color: #ccc;
            margin: 20px auto;
            cursor: pointer;
        }
        .animal-block {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .resource-list {
            list-style: none;
            padding: 0;
        }
        .resource-list li {
            margin: 5px 0;
        }
        .daily-reward, .market-item {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="header">
            <span id="coin-count">–ú–æ–Ω–µ—Ç—ã: 0</span>
            <span id="crystal-count">–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: 0</span>
        </div>
        <div class="tab-content" id="farmer-tab">
            <h2>–§–µ—Ä–º–µ—Ä</h2>
            <div id="clicker"></div>
        </div>
        <div class="tab-content" id="farm-tab" style="display: none;">
            <h2>–§–µ—Ä–º–∞</h2>
            <div id="animals"></div>
        </div>
        <div class="tab-content" id="warehouse-tab" style="display: none;">
            <h2>–°–∫–ª–∞–¥</h2>
            <div id="warehouse-content"></div>
        </div>
        <div class="tab-content" id="town-tab" style="display: none;">
            <h2>–ì–æ—Ä–æ–¥</h2>
            <button id="daily-reward">–ü–æ–ª—É—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É</button>
            <button id="fortune-wheel">–ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</button>
            <div id="rating">
                <h3>–†–µ–π—Ç–∏–Ω–≥</h3>
                <ul id="rating-list"></ul>
            </div>
            <div id="crystal-shop">
                <h3>–ú–∞–≥–∞–∑–∏–Ω –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤</h3>
                <button onclick="buyCrystals(10, 100)">–ö—É–ø–∏—Ç—å 10 üíé –∑–∞ 100‚ÇΩ</button>
                <button onclick="buyCrystals(50, 450)">–ö—É–ø–∏—Ç—å 50 üíé –∑–∞ 450‚ÇΩ</button>
            </div>
        </div>
        <div class="tab-content" id="market-tab" style="display: none;">
            <h2>–†—ã–Ω–æ–∫</h2>
            <div id="market-items"></div>
            <button onclick="showMyShop()">–ú–æ—è –ª–∞–≤–∫–∞</button>
            <div id="my-shop" style="display: none;">
                <h3>–ú–æ—è –ª–∞–≤–∫–∞</h3>
                <div id="shop-items"></div>
                <button onclick="showAddResourceForm()">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Å—É—Ä—Å</button>
                <div id="add-resource-form" style="display: none;">
                    <h4>–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Å—É—Ä—Å</h4>
                    <select id="resource-type">
                        <option value="eggs">–Ø–π—Ü–∞</option>
                        <option value="wool">–®–µ—Ä—Å—Ç—å</option>
                        <option value="milk">–ú–æ–ª–æ–∫–æ</option>
                        <option value="honey">–ú–µ–¥</option>
                    </select>
                    <input type="number" id="resource-amount" min="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                    <input type="number" id="resource-price" min="1" placeholder="–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É">
                    <button onclick="addResourceForSale()">–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∂—É</button>
                </div>
            </div>
        </div>
        <div class="bottom-bar">
            <button data-target="farm-tab">–§–µ—Ä–º–∞</button>
            <button data-target="warehouse-tab">–°–∫–ª–∞–¥</button>
            <button data-target="farmer-tab">–§–µ—Ä–º–µ—Ä</button>
            <button data-target="town-tab">–ì–æ—Ä–æ–¥</button>
            <button data-target="market-tab">–†—ã–Ω–æ–∫</button>
        </div>
    </div>
    <script>
        function setThemeClass() {
            document.documentElement.className = Telegram.WebApp.colorScheme;
        }
        Telegram.WebApp.onEvent('themeChanged', setThemeClass);
        setThemeClass();
        Telegram.WebApp.requestFullscreen();

        const userId = Telegram.WebApp.initDataUnsafe.user.id;
        const storageKey = `farm_game_${userId}`;
        let userData = JSON.parse(localStorage.getItem(storageKey));

        const warehouseLevels = [1000, 3000, 5000, 7000, 10000];

        if (!userData) {
            userData = {
                coins: 0,
                crystals: 0,
                warehouse_level: 1,
                farm_level: 1,
                animals: {
                    chickens: 5,
                    sheep: 0,
                    cows: 0,
                    bees: 0
                },
                resources: {
                    eggs: 0,
                    wool: 0,
                    milk: 0,
                    honey: 0,
                    boards: 0,
                    nails: 0
                },
                production: {
                    eggs: { startTime: 0, isProducing: false },
                    wool: { startTime: 0, isProducing: false },
                    milk: { startTime: 0, isProducing: false },
                    honey: { startTime: 0, isProducing: false }
                },
                lastDailyClaim: 0,
                shop_slots: 3,
                myShopItems: []
            };
            localStorage.setItem(storageKey, JSON.stringify(userData));
        }

        function saveUserData() {
            localStorage.setItem(storageKey, JSON.stringify(userData));
        }

        function updateCoinDisplay() {
            document.getElementById('coin-count').textContent = `–ú–æ–Ω–µ—Ç—ã: ${userData.coins}`;
            document.getElementById('crystal-count').textContent = `–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: ${userData.crystals}`;
        }
        updateCoinDisplay();



        document.getElementById('clicker').addEventListener('click', () => {
            userData.coins += 1;
            saveUserData();
            updateCoinDisplay();
        });


        document.querySelectorAll('.bottom-bar button').forEach(button => {
            button.addEventListener('click', () => {
                const target = button.getAttribute('data-target');
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.style.display = tab.id === target ? 'block' : 'none';
                });
                if (target === 'farm-tab') {
                    updateFarmTab();
                } else if (target === 'warehouse-tab') {
                    updateWarehouseTab();
                } else if (target === 'town-tab') {
                    updateTownTab();
                } else if (target === 'market-tab') {
                    updateMarketTab();
                }
            });
        });


        function getProductionTime(resource, farmLevel) {
            const productionTimes = {
                eggs: {
                    1: 3 * 60 * 60 * 1000,
                    2: 2.5 * 60 * 60 * 1000,
                    3: 2 * 60 * 60 * 1000,
                    4: 1.5 * 60 * 60 * 1000,
                    5: 1 * 60 * 60 * 1000
                },
                wool: {
                    1: 6 * 60 * 60 * 1000,
                    2: 5.5 * 60 * 60 * 1000,
                    3: 5 * 60 * 60 * 1000,
                    4: 4.5 * 60 * 60 * 1000,
                    5: 4 * 60 * 60 * 1000
                },
                milk: {
                    1: 8 * 60 * 60 * 1000,
                    2: 7 * 60 * 60 * 1000,
                    3: 6 * 60 * 60 * 1000,
                    4: 5 * 60 * 60 * 1000,
                    5: 4 * 60 * 60 * 1000
                },
                honey: {
                    1: 12 * 60 * 60 * 1000,
                    2: 10 * 60 * 60 * 1000,
                    3: 8 * 60 * 60 * 1000,
                    4: 6 * 60 * 60 * 1000,
                    5: 4 * 60 * 60 * 1000
                }
            };
            return productionTimes[resource][farmLevel];
        }

        function updateFarmTab() {
            const animalsDiv = document.getElementById('animals');
            animalsDiv.innerHTML = '';
            const animalTypes = ['chickens', 'sheep', 'cows', 'bees'];
            animalTypes.forEach(type => {
                const count = userData.animals[type];
                if (count > 0) {
                    const resource = type === 'chickens' ? 'eggs' : type === 'sheep' ? 'wool' : type === 'cows' ? 'milk' : 'honey';
                    const production = userData.production[resource];
                    let status = '';
                    if (production.isProducing) {
                        const duration = getProductionTime(resource, userData.farm_level);
                        const endTime = production.startTime + duration;
                        const currentTime = Date.now();
                        if (currentTime >= endTime) {
                            const amount = count;
                            const capacity = warehouseLevels[userData.warehouse_level - 1];
                            const used = Object.values(userData.resources).reduce((sum, val) => sum + val, 0);
                            const free = capacity - used;
                            const toAdd = Math.min(amount, free);
                            userData.resources[resource] += toAdd;
                            production.isProducing = false;
                            saveUserData();
                            status = `–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –î–æ–±–∞–≤–ª–µ–Ω–æ ${toAdd} ${resource}.`;
                        } else {
                            const remaining = endTime - currentTime;
                            status = `–ò–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ... –û—Å—Ç–∞–ª–æ—Å—å: ${Math.ceil(remaining / 1000)} —Å–µ–∫—É–Ω–¥`;
                        }
                    } else {
                        status = `<button onclick="startProduction('${resource}')">–ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ ${resource}</button>`;
                    }
                    const animalBlock = document.createElement('div');
                    animalBlock.className = 'animal-block';
                    animalBlock.innerHTML = `<p>${type.charAt(0).toUpperCase() + type.slice(1)}: ${count}</p><p>${status}</p>`;
                    animalsDiv.appendChild(animalBlock);
                }
            });
        }

        function startProduction(resource) {
            const animalType = resource === 'eggs' ? 'chickens' : resource === 'wool' ? 'sheep' : resource === 'milk' ? 'cows' : 'bees';
            if (userData.animals[animalType] === 0) {
                alert(`–£ –≤–∞—Å –Ω–µ—Ç ${animalType} –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ ${resource}.`);
                return;
            }
            if (userData.production[resource].isProducing) {
                alert(`–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ ${resource} —É–∂–µ –∏–¥–µ—Ç.`);
                return;
            }
            userData.production[resource].startTime = Date.now();
            userData.production[resource].isProducing = true;
            saveUserData();
            updateFarmTab();
        }


        function updateWarehouseTab() {
            const warehouseDiv = document.getElementById('warehouse-content');
            warehouseDiv.innerHTML = '';
            const capacity = warehouseLevels[userData.warehouse_level - 1];
            const used = Object.values(userData.resources).reduce((sum, val) => sum + val, 0);
            const free = capacity - used;
            let html = `<p>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${capacity}, –°–≤–æ–±–æ–¥–Ω–æ: ${free}</p><ul class="resource-list">`;
            for (const [resource, amount] of Object.entries(userData.resources)) {
                if (amount > 0) {
                    html += `<li>${resource}: ${amount}</li>`;
                }
            }
            html += '</ul>';
            warehouseDiv.innerHTML = html;
        }


        function updateTownTab() {
            document.getElementById('daily-reward').addEventListener('click', () => {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                if (now - userData.lastDailyClaim >= oneDay) {
                    userData.coins += 300;
                    userData.lastDailyClaim = now;
                    saveUserData();
                    updateCoinDisplay();
                    alert('–ü–æ–ª—É—á–µ–Ω–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞: 300 –º–æ–Ω–µ—Ç');
                } else {
                    alert('–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É —Ä–∞–∑ –≤ –¥–µ–Ω—å.');
                }
            });

            document.getElementById('fortune-wheel').addEventListener('click', () => {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                if (now - (userData.lastFortuneSpin || 0) >= oneDay) {
                    const prizes = [
                        { name: '–ú–æ–Ω–µ—Ç—ã', amount: Math.floor(Math.random() * 401) + 100, type: 'coins' },
                        { name: '–ö—Ä–∏—Å—Ç–∞–ª–ª—ã', amount: 10, type: 'crystals' }
                    ];
                    const prize = prizes[Math.floor(Math.random() * prizes.length)];
                    if (prize.type === 'coins') {
                        userData.coins += prize.amount;
                    } else {
                        userData.crystals += prize.amount;
                    }
                    userData.lastFortuneSpin = now;
                    saveUserData();
                    updateCoinDisplay();
                    alert(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${prize.amount} ${prize.name}`);
                } else {
                    alert('–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã –º–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å —Ä–∞–∑ –≤ –¥–µ–Ω—å.');
                }
            });

            const ratingList = document.getElementById('rating-list');
            ratingList.innerHTML = '';
            const simulatedRating = [
                { name: '–ò–≥—Ä–æ–∫ 1', coins: 1000 },
                { name: '–ò–≥—Ä–æ–∫ 2', coins: 800 },
                { name: '–í—ã', coins: userData.coins }
            ].sort((a, b) => b.coins - a.coins);
            simulatedRating.forEach((player, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${player.name} - ${player.coins} –º–æ–Ω–µ—Ç`;
                ratingList.appendChild(li);
            });
        }

        function buyCrystals(amount, price) {
            alert(`–î–ª—è –ø–æ–∫—É–ø–∫–∏ ${amount} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –∑–∞ ${price}‚ÇΩ, –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —á–µ–∫.`);
        }


        const marketItems = [
            { id: 1, resource: 'eggs', amount: 10, price: 5, seller: '–ò–≥—Ä–æ–∫ 1' },
            { id: 2, resource: 'wool', amount: 5, price: 10, seller: '–ò–≥—Ä–æ–∫ 2' }
        ];

        function updateMarketTab() {
            const marketItemsDiv = document.getElementById('market-items');
            marketItemsDiv.innerHTML = '';
            marketItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'market-item';
                div.innerHTML = `<p>${item.resource}: ${item.amount} –ø–æ ${item.price} –º–æ–Ω–µ—Ç (–ü—Ä–æ–¥–∞–≤–µ—Ü: ${item.seller})</p>
                    <button onclick="buyResource(${item.id})">–ö—É–ø–∏—Ç—å</button>`;
                marketItemsDiv.appendChild(div);
            });
        }

        function buyResource(itemId) {
            const item = marketItems.find(i => i.id === itemId);
            const totalCost = item.amount * item.price;
            if (userData.coins < totalCost) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç.');
                return;
            }
            const capacity = warehouseLevels[userData.warehouse_level - 1];
            const used = Object.values(userData.resources).reduce((sum, val) => sum + val, 0);
            const free = capacity - used;
            if (item.amount > free) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ.');
                return;
            }
            userData.coins -= totalCost;
            userData.resources[item.resource] += item.amount;
            saveUserData();
            updateCoinDisplay();
            updateWarehouseTab();
            alert(`–ö—É–ø–ª–µ–Ω–æ ${item.amount} ${item.resource} –∑–∞ ${totalCost} –º–æ–Ω–µ—Ç.`);
        }

        function showMyShop() {
            document.getElementById('my-shop').style.display = 'block';
            const shopItemsDiv = document.getElementById('shop-items');
            shopItemsDiv.innerHTML = '';
            userData.myShopItems.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = `<p>${item.resource}: ${item.amount} –ø–æ ${item.price} –º–æ–Ω–µ—Ç</p>
                    <button onclick="removeResourceFromShop(${item.id})">–°–Ω—è—Ç—å —Å –ø—Ä–æ–¥–∞–∂–∏</button>`;
                shopItemsDiv.appendChild(div);
            });
        }

        function showAddResourceForm() {
            document.getElementById('add-resource-form').style.display = 'block';
        }

        function addResourceForSale() {
            const resource = document.getElementById('resource-type').value;
            const amount = parseInt(document.getElementById('resource-amount').value);
            const price = parseInt(document.getElementById('resource-price').value);
            if (isNaN(amount) || amount <= 0 || isNaN(price) || price <= 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.');
                return;
            }
            if (userData.resources[resource] < amount) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤.');
                return;
            }
            userData.resources[resource] -= amount;
            userData.myShopItems.push({ id: Date.now(), resource, amount, price });
            saveUserData();
            updateWarehouseTab();
            showMyShop();
            document.getElementById('add-resource-form').style.display = 'none';
        }

        function removeResourceFromShop(itemId) {
            const item = userData.myShopItems.find(i => i.id === itemId);
            const capacity = warehouseLevels[userData.warehouse_level - 1];
            const used = Object.values(userData.resources).reduce((sum, val) => sum + val, 0);
            const free = capacity - used;
            if (item.amount > free) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ.');
                return;
            }
            userData.resources[item.resource] += item.amount;
            userData.myShopItems = userData.myShopItems.filter(i => i.id !== itemId);
            saveUserData();
            updateWarehouseTab();
            showMyShop();
        }
    </script>
</body>
</html>