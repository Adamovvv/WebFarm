<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Фермерский магнат</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a; /* Темный фон */
            color: #fff; /* Белый текст */
            font-family: sans-serif;
            overflow: hidden;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 16px;
        }
        .tab-content {
            flex: 1;
            overflow: auto;
            background-color: #2a2a2a; /* Темный фон для вкладок */
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px;
        }
        .bottom-bar {
            display: flex;
            justify-content: space-around;
            background-color: #ccc;
            border-radius: 16px;
            height: 64px;
            margin: 16px;
            position: fixed;
            bottom: 16px;
            left: 0;
            right: 0;
        }
        .bottom-bar button {
            padding: 12px;
            background-color: #4CAF50; /* Зеленые кнопки */
            color: white;
            border: none;
            cursor: pointer;
        }
        .tabs {
            margin-bottom: 20px;
        }
        .tabs button {
            padding: 10px 20px;
            margin-right: 10px;
            background-color: #4CAF50; /* Зеленые кнопки */
            border: none;
            color: white;
            cursor: pointer;
        }
        .tabs button:hover {
            background-color: #45a049;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        .crop-block, .animal-block {
            background-color: #3a3a3a; /* Темный фон блоков */
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #666;
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="header">
            <span id="coin-count">Монеты: 0</span>
            <span id="crystal-count">Кристаллы: 0</span>
        </div>
        <div class="tab-content" id="farmer-tab">
            <h2>Фермер</h2>
            <div id="clicker"></div>
        </div>
        <div class="tab-content" id="farm-tab" style="display: none;">
            <h2>Ферма</h2>
            <div class="tabs">
                <button data-tab="crops">Культуры</button>
                <button data-tab="animals">Животные</button>
            </div>
            <div id="crops" class="tab-panel active">
                <h3>Культуры</h3>
                <div id="crops-list"></div>
            </div>
            <div id="animals" class="tab-panel">
                <h3>Животные</h3>
                <div id="animals-list"></div>
            </div>
        </div>
        <div class="tab-content" id="warehouse-tab" style="display: none;">
            <h2>Склад</h2>
            <div id="warehouse-content"></div>
        </div>
        <div class="tab-content" id="town-tab" style="display: none;">
            <h2>Город</h2>
            <button id="daily-reward">Получить ежедневную награду</button>
            <button id="fortune-wheel">Крутить колесо фортуны</button>
        </div>
        <div class="tab-content" id="top-tab" style="display: none;">
            <h3>Рейтинг</h3>
            <ul id="rating-list"></ul>
        </div>
        <div class="bottom-bar">
            <button data-target="farm-tab">Ферма</button>
            <button data-target="warehouse-tab">Склад</button>
            <button data-target="farmer-tab">Фермер</button>
            <button data-target="town-tab">Город</button>
            <button data-target="top-tab">Топ</button>
        </div>
    </div>
    <script>
    Telegram.WebApp.onEvent('themeChanged', () => {
        document.documentElement.className = Telegram.WebApp.colorScheme;
    });
    document.documentElement.className = Telegram.WebApp.colorScheme;
    Telegram.WebApp.requestFullscreen();

    const userId = Telegram.WebApp.initDataUnsafe.user.id;
    const storageKey = `farm_game_${userId}`;
    let userData = JSON.parse(localStorage.getItem(storageKey)) || {
        coins: 0,
        crystals: 0,
        warehouse_level: 1,
        farm_level: 1,
        crops: {
            wheat: { amount: 0, producing: false, endTime: 0 }, // Пшеница
            potato: { amount: 0, producing: false, endTime: 0 }, // Картофель
            carrot: { amount: 0, producing: false, endTime: 0 }  // Морковь
        },
        animals: {
            chicken: { amount: 0, requiredCrop: 'wheat' }, // Курица требует пшеницу
            sheep: { amount: 0, requiredCrop: 'potato' },  // Овца требует картофель
            cow: { amount: 0, requiredCrop: 'carrot' }     // Корова требует морковь
        },
        resources: {
            eggs: 0,
            wool: 0,
            milk: 0,
            boards: 0,
            nails: 0
        },
        production: {
            eggs: { startTime: 0, isProducing: false },
            wool: { startTime: 0, isProducing: false },
            milk: { startTime: 0, isProducing: false }
        },
        lastDailyClaim: 0,
        shop_slots: 3,
        myShopItems: []
    };
    localStorage.setItem(storageKey, JSON.stringify(userData));

    // Сохранение данных
    function saveUserData() {
        localStorage.setItem(storageKey, JSON.stringify(userData));
    }

    // Обновление отображения монет и кристаллов
    function updateCoinDisplay() {
        document.getElementById('coin-count').textContent = `Монеты: ${userData.coins}`;
        document.getElementById('crystal-count').textContent = `Кристаллы: ${userData.crystals}`;
    }
    updateCoinDisplay();

    // Кликер для монет
    document.getElementById('clicker').addEventListener('click', () => {
        userData.coins += 1;
        saveUserData();
        updateCoinDisplay();
    });

    // Переключение основных вкладок
    document.querySelectorAll('.bottom-bar button').forEach(button => {
        button.addEventListener('click', () => {
            const target = button.getAttribute('data-target');
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = tab.id === target ? 'block' : 'none';
            });
            if (target === 'farm-tab') updateFarmTab();
            else if (target === 'warehouse-tab') updateWarehouseTab();
            else if (target === 'town-tab') updateTownTab();
        });
    });

    // Обновление вкладки "Ферма"
    function updateFarmTab() {
        updateCropsTab();
        updateAnimalsTab();
    }

    // Обновление таба "Культуры"
    function updateCropsTab() {
        const cropsList = document.getElementById('crops-list');
        cropsList.innerHTML = '';
        const crops = [
            { id: 'wheat', name: 'Пшеница' },
            { id: 'potato', name: 'Картофель' },
            { id: 'carrot', name: 'Морковь' }
        ];
        crops.forEach(crop => {
            const data = userData.crops[crop.id];
            let status = '';
            if (data.producing) {
                const remaining = data.endTime - Date.now();
                if (remaining > 0) {
                    status = `Производство... ${Math.ceil(remaining / 1000)} сек`;
                } else {
                    userData.crops[crop.id].amount += 1;
                    userData.crops[crop.id].producing = false;
                    saveUserData();
                    status = 'Завершено. +1 единица.';
                }
            } else {
                status = `<button onclick="produceCrop('${crop.id}')">Произвести</button>`;
            }
            const cropBlock = document.createElement('div');
            cropBlock.className = 'crop-block';
            cropBlock.innerHTML = `<p>${crop.name}: ${data.amount}</p><p>${status}</p>`;
            cropsList.appendChild(cropBlock);
        });
    }

    // Обновление таба "Животные"
    function updateAnimalsTab() {
        const animalsList = document.getElementById('animals-list');
        animalsList.innerHTML = '';
        const animals = [
            { id: 'chicken', name: 'Курица', resource: 'eggs' },
            { id: 'sheep', name: 'Овца', resource: 'wool' },
            { id: 'cow', name: 'Корова', resource: 'milk' }
        ];
        animals.forEach(animal => {
            const data = userData.animals[animal.id];
            const requiredCrop = data.requiredCrop;
            const canProduce = userData.crops[requiredCrop].amount > 0;
            let button = canProduce
                ? `<button onclick="produceAnimal('${animal.id}')">Произвести</button>`
                : `Требуется: ${requiredCrop}`;
            const animalBlock = document.createElement('div');
            animalBlock.className = 'animal-block';
            animalBlock.innerHTML = `<p>${animal.name}: ${data.amount}</p>${button}`;
            animalsList.appendChild(animalBlock);
        });
    }

    // Производство культур
    function produceCrop(crop) {
        if (userData.crops[crop].producing) {
            alert(`Производство ${crop} уже идет!`);
            return;
        }
        const productionTime = 60 * 1000; // 1 минута
        userData.crops[crop].producing = true;
        userData.crops[crop].endTime = Date.now() + productionTime;
        saveUserData();
        updateFarmTab();
        setTimeout(() => {
            userData.crops[crop].amount += 1;
            userData.crops[crop].producing = false;
            saveUserData();
            updateFarmTab();
        }, productionTime);
    }

    // Производство животных
    function produceAnimal(animal) {
        const requiredCrop = userData.animals[animal].requiredCrop;
        if (userData.crops[requiredCrop].amount <= 0) {
            alert(`Недостаточно ${requiredCrop} для производства!`);
            return;
        }
        userData.crops[requiredCrop].amount -= 1;
        userData.animals[animal].amount += 1;
        saveUserData();
        updateFarmTab();
    }

    // Переключение табов внутри "Фермы"
    document.querySelectorAll('.tabs button').forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.getAttribute('data-tab');
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === tab);
            });
            updateFarmTab();
        });
    });

    // Обновление склада (оставлено как есть)
    function updateWarehouseTab() {
        const warehouseDiv = document.getElementById('warehouse-content');
        const capacity = [1000, 3000, 5000, 7000, 10000][userData.warehouse_level - 1];
        const used = Object.values(userData.resources).reduce((sum, val) => sum + val, 0);
        let html = `<p>Вместимость: ${capacity}, Свободно: ${capacity - used}</p><ul>`;
        for (const [res, amount] of Object.entries(userData.resources)) {
            if (amount > 0) html += `<li>${res}: ${amount}</li>`;
        }
        html += '</ul>';
        warehouseDiv.innerHTML = html;
    }

    // Обновление города (оставлено как есть)
    function updateTownTab() {
        document.getElementById('daily-reward').addEventListener('click', () => {
            const now = Date.now();
            if (now - userData.lastDailyClaim >= 24 * 60 * 60 * 1000) {
                userData.coins += 300;
                userData.lastDailyClaim = now;
                saveUserData();
                updateCoinDisplay();
                alert('Получено 300 монет!');
            } else {
                alert('Награда доступна раз в день.');
            }
        });
    }

    // Обновление каждую секунду для таймеров
    setInterval(updateFarmTab, 1000);

    // Инициализация
    updateFarmTab();
</script>
</body>
</html>