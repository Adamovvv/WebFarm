<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–µ—Ä–º–µ—Ä—Å–∫–∏–π –º–∞–≥–Ω–∞—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <div id="header">
            <div class="lyi0vd">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14.0049 2.00281C18.4232 2.00281 22.0049 5.58453 22.0049 10.0028C22.0049 13.2474 20.0733 16.0409 17.2973 17.296C16.0422 20.0718 13.249 22.0028 10.0049 22.0028C5.5866 22.0028 2.00488 18.4211 2.00488 14.0028C2.00488 10.7587 3.9359 7.96554 6.71122 6.71012C7.96681 3.93438 10.7603 2.00281 14.0049 2.00281ZM11.0049 9.00281H9.00488V10.0028C7.62417 10.0028 6.50488 11.1221 6.50488 12.5028C6.50488 13.8283 7.53642 14.9128 8.84051 14.9975L9.00488 15.0028H11.0049L11.0948 15.0109C11.328 15.0532 11.5049 15.2573 11.5049 15.5028C11.5049 15.7483 11.328 15.9524 11.0948 15.9948L11.0049 16.0028H7.00488V18.0028H9.00488V19.0028H11.0049V18.0028C12.3856 18.0028 13.5049 16.8835 13.5049 15.5028C13.5049 14.1773 12.4733 13.0928 11.1693 13.0081L11.0049 13.0028H9.00488L8.91501 12.9948C8.68176 12.9524 8.50488 12.7483 8.50488 12.5028C8.50488 12.2573 8.68176 12.0532 8.91501 12.0109L9.00488 12.0028H13.0049V10.0028H11.0049V9.00281ZM14.0049 4.00281C12.2214 4.00281 10.6196 4.78097 9.52064 6.01629C9.68133 6.00764 9.84254 6.00281 10.0049 6.00281C14.4232 6.00281 18.0049 9.58453 18.0049 14.0028C18.0049 14.1655 18 14.327 17.9905 14.4873C19.2265 13.3885 20.0049 11.7866 20.0049 10.0028C20.0049 6.6891 17.3186 4.00281 14.0049 4.00281Z"></path></svg>
                <span id="coin-count">–ú–æ–Ω–µ—Ç—ã: 0</span>
            </div>
            <div class="lyi0vd">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.0049 22.0027C6.48204 22.0027 2.00488 17.5256 2.00488 12.0027C2.00488 6.4799 6.48204 2.00275 12.0049 2.00275C17.5277 2.00275 22.0049 6.4799 22.0049 12.0027C22.0049 17.5256 17.5277 22.0027 12.0049 22.0027ZM9.50488 9.00275L7.00488 11.5027L12.0041 16.5027L17.0049 11.5027L14.5049 9.00275H9.50488Z"></path></svg>
                <span id="crystal-count">–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: 0</span>
            </div>
        </div>
        <div class="tab-content" id="farmer-tab">
            <h2>–§–µ—Ä–º–µ—Ä</h2>
            <div id="clicker"></div>
        </div>
        <div class="tab-content" id="farm-tab" style="display: none;">
            <h2>–§–µ—Ä–º–∞</h2>
            <div class="farm-tabs">
                <button data-target="animals-tab" class="active">–ñ–∏–≤–æ—Ç–Ω—ã–µ</button>
                <button data-target="crops-tab">–ö—É–ª—å—Ç—É—Ä—ã</button>
            </div>
            <div id="animals-tab" class="farm-tab-content active">
                <div id="animals"></div>
            </div>
            <div id="crops-tab" class="farm-tab-content" style="display: none;">
                <div id="crops"></div>
            </div>
        </div>
        <div class="tab-content" id="warehouse-tab" style="display: none;">
            <h2>–°–∫–ª–∞–¥</h2>
            <div id="warehouse-content"></div>
        </div>
        <div class="tab-content" id="town-tab" style="display: none;">
            <h2>–ì–æ—Ä–æ–¥</h2>
            <button id="daily-reward">–ü–æ–ª—É—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É</button>
            <button id="fortune-wheel">–ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</button>
            <div id="crystal-shop">
                <h3>–ú–∞–≥–∞–∑–∏–Ω –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤</h3>
                <button onclick="buyCrystals(10, 100)">–ö—É–ø–∏—Ç—å 10 üíé –∑–∞ 100‚ÇΩ</button>
                <button onclick="buyCrystals(50, 450)">–ö—É–ø–∏—Ç—å 50 üíé –∑–∞ 450‚ÇΩ</button>
            </div>
        </div>
        <div class="tab-content" id="top-tab" style="display: none;">
            <div id="rating">
                <h3>–†–µ–π—Ç–∏–Ω–≥</h3>
                <ul id="rating-list"></ul>
            </div>
        </div>
        <div class="bottom-bar">
            <button data-target="farm-tab">–§–µ—Ä–º–∞</button>
            <button data-target="warehouse-tab">–°–∫–ª–∞–¥</button>
            <button data-target="farmer-tab">–§–µ—Ä–º–µ—Ä</button>
            <button data-target="town-tab">–ì–æ—Ä–æ–¥</button>
            <button data-target="top-tab">–¢–æ–ø</button>
        </div>
    </div>
    <script>
        function setThemeClass() {
            document.documentElement.className = Telegram.WebApp.colorScheme;
        }
        Telegram.WebApp.onEvent('themeChanged', setThemeClass);
        setThemeClass();
        Telegram.WebApp.requestFullscreen();

        const userId = Telegram.WebApp.initDataUnsafe.user.id;
        const storageKey = `farm_game_${userId}`;
        let userData = JSON.parse(localStorage.getItem(storageKey));

        const warehouseLevels = [1000, 3000, 5000, 7000, 10000];

        if (!userData) {
            userData = {
                coins: 0,
                crystals: 0,
                warehouse_level: 1,
                farm_level: 1,
                animals: {
                    chickens: 5,
                    sheep: 0,
                    cows: 0,
                    bees: 0
                },
                resources: {
                    eggs: 0,
                    wool: 0,
                    milk: 0,
                    honey: 0,
                    wheat: 0,
                    corn: 0,
                    carrot: 0,
                    boards: 0,
                    nails: 0
                },
                production: {
                    eggs: { startTime: 0, isProducing: false },
                    wool: { startTime: 0, isProducing: false },
                    milk: { startTime: 0, isProducing: false },
                    honey: { startTime: 0, isProducing: false },
                    wheat: { startTime: 0, isProducing: false },
                    corn: { startTime: 0, isProducing: false },
                    carrot: { startTime: 0, isProducing: false }
                },
                lastDailyClaim: 0
            };
            localStorage.setItem(storageKey, JSON.stringify(userData));
        }

        function saveUserData() {
            localStorage.setItem(storageKey, JSON.stringify(userData));
        }

        function updateCoinDisplay() {
            document.getElementById('coin-count').textContent = `–ú–æ–Ω–µ—Ç—ã: ${userData.coins}`;
            document.getElementById('crystal-count').textContent = `–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: ${userData.crystals}`;
        }
        updateCoinDisplay();



        document.getElementById('clicker').addEventListener('click', () => {
            userData.coins += 1;
            saveUserData();
            updateCoinDisplay();
        });


        document.querySelectorAll('.bottom-bar button').forEach(button => {
            button.addEventListener('click', () => {
                const target = button.getAttribute('data-target');
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.style.display = tab.id === target ? 'block' : 'none';
                });
                if (target === 'farm-tab') {
                    updateAnimalsTab();
                } else if (target === 'warehouse-tab') {
                    updateWarehouseTab();
                } else if (target === 'town-tab') {
                    updateTownTab();
                } else if (target === 'market-tab') {
                    updateMarketTab();
                }
            });
        });


        function getProductionTime(resource, farmLevel) {
            const productionTimes = {
                eggs: {
                    1: 3 * 60 * 60 * 1000,
                    2: 2.5 * 60 * 60 * 1000,
                    3: 2 * 60 * 60 * 1000,
                    4: 1.5 * 60 * 60 * 1000,
                    5: 1 * 60 * 60 * 1000
                },
                wool: {
                    1: 6 * 60 * 60 * 1000,
                    2: 5.5 * 60 * 60 * 1000,
                    3: 5 * 60 * 60 * 1000,
                    4: 4.5 * 60 * 60 * 1000,
                    5: 4 * 60 * 60 * 1000
                },
                milk: {
                    1: 8 * 60 * 60 * 1000,
                    2: 7 * 60 * 60 * 1000,
                    3: 6 * 60 * 60 * 1000,
                    4: 5 * 60 * 60 * 1000,
                    5: 4 * 60 * 60 * 1000
                },
                honey: {
                    1: 12 * 60 * 60 * 1000,
                    2: 10 * 60 * 60 * 1000,
                    3: 8 * 60 * 60 * 1000,
                    4: 6 * 60 * 60 * 1000,
                    5: 4 * 60 * 60 * 1000
                }
            };
            return productionTimes[resource][farmLevel];
        }

        const resourceRequirements = {
            eggs: { crop: 'wheat', amount: 1 },
            wool: { crop: 'corn', amount: 2 },
            milk: { crop: 'carrot', amount: 3 },
            honey: { crop: 'wheat', amount: 1 }
        };

        function startAnimalProduction(resource) {
            const animalType = resource === 'eggs' ? 'chickens' : resource === 'wool' ? 'sheep' : resource === 'milk' ? 'cows' : 'bees';
            if (userData.animals[animalType] === 0) {
                alert(`–£ –≤–∞—Å –Ω–µ—Ç ${animalType} –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ ${resource}.`);
                return;
            }
            if (userData.production[resource].isProducing) {
                alert(`–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ ${resource} —É–∂–µ –∏–¥–µ—Ç.`);
                return;
            }
            const requirement = resourceRequirements[resource];
            const requiredAmount = requirement.amount * userData.animals[animalType];
            if (userData.resources[requirement.crop] < requiredAmount) {
                alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${requirement.crop} –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ ${resource}. –¢—Ä–µ–±—É–µ—Ç—Å—è: ${requiredAmount}.`);
                return;
            }
            userData.resources[requirement.crop] -= requiredAmount;
            userData.production[resource].startTime = Date.now();
            userData.production[resource].isProducing = true;
            saveUserData();
            updateWarehouseTab();
            updateAnimalsTab();
        }

        function updateAnimalsTab() {
            const animalsDiv = document.getElementById('animals');
            animalsDiv.innerHTML = '';
            const animalTypes = ['chickens', 'sheep', 'cows', 'bees'];
            animalTypes.forEach(type => {
                const count = userData.animals[type];
                if (count > 0) {
                    const resource = type === 'chickens' ? 'eggs' : type === 'sheep' ? 'wool' : type === 'cows' ? 'milk' : 'honey';
                    const production = userData.production[resource];
                    let status = '';
                    if (production.isProducing) {
                        const duration = getProductionTime(resource, userData.farm_level);
                        const endTime = production.startTime + duration;
                        const currentTime = Date.now();
                        if (currentTime >= endTime) {
                            const amount = count;
                            const capacity = warehouseLevels[userData.warehouse_level - 1];
                            const used = Object.values(userData.resources).reduce((sum, val) => sum + val, 0);
                            const free = capacity - used;
                            const toAdd = Math.min(amount, free);
                            userData.resources[resource] += toAdd;
                            production.isProducing = false;
                            saveUserData();
                            status = `–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –î–æ–±–∞–≤–ª–µ–Ω–æ ${toAdd} ${resource}.`;
                        } else {
                            const remaining = endTime - currentTime;
                            status = `–ò–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ... –û—Å—Ç–∞–ª–æ—Å—å: ${Math.ceil(remaining / 1000)} —Å–µ–∫—É–Ω–¥`;
                        }
                    } else {
                        status = `<button onclick="startAnimalProduction('${resource}')">–ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ ${resource}</button>`;
                    }
                    const animalBlock = document.createElement('div');
                    animalBlock.className = 'animal-block';
                    animalBlock.innerHTML = `<p>${type.charAt(0).toUpperCase() + type.slice(1)}: ${count}</p><p>${status}</p>`;
                    animalsDiv.appendChild(animalBlock);
                }
            });
        }

        function updateWarehouseTab() {
            const warehouseDiv = document.getElementById('warehouse-content');
            warehouseDiv.innerHTML = '';
            const capacity = warehouseLevels[userData.warehouse_level - 1];
            const used = Object.values(userData.resources).reduce((sum, val) => sum + val, 0);
            const free = capacity - used;
            let html = `<p>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${capacity}, –°–≤–æ–±–æ–¥–Ω–æ: ${free}</p><ul class="resource-list">`;
            for (const [resource, amount] of Object.entries(userData.resources)) {
                if (amount > 0) {
                    html += `<li>${resource}: ${amount}</li>`;
                }
            }
            html += '</ul>';
            warehouseDiv.innerHTML = html;
        }


        function updateTownTab() {
            document.getElementById('daily-reward').addEventListener('click', () => {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                if (now - userData.lastDailyClaim >= oneDay) {
                    userData.coins += 300;
                    userData.lastDailyClaim = now;
                    saveUserData();
                    updateCoinDisplay();
                    alert('–ü–æ–ª—É—á–µ–Ω–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞: 300 –º–æ–Ω–µ—Ç');
                } else {
                    alert('–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É —Ä–∞–∑ –≤ –¥–µ–Ω—å.');
                }
            });

            document.getElementById('fortune-wheel').addEventListener('click', () => {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                if (now - (userData.lastFortuneSpin || 0) >= oneDay) {
                    const prizes = [
                        { name: '–ú–æ–Ω–µ—Ç—ã', amount: Math.floor(Math.random() * 401) + 100, type: 'coins' },
                        { name: '–ö—Ä–∏—Å—Ç–∞–ª–ª—ã', amount: 10, type: 'crystals' }
                    ];
                    const prize = prizes[Math.floor(Math.random() * prizes.length)];
                    if (prize.type === 'coins') {
                        userData.coins += prize.amount;
                    } else {
                        userData.crystals += prize.amount;
                    }
                    userData.lastFortuneSpin = now;
                    saveUserData();
                    updateCoinDisplay();
                    alert(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${prize.amount} ${prize.name}`);
                } else {
                    alert('–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã –º–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å —Ä–∞–∑ –≤ –¥–µ–Ω—å.');
                }
            });

            const ratingList = document.getElementById('rating-list');
            ratingList.innerHTML = '';
            const simulatedRating = [
                { name: '–ò–≥—Ä–æ–∫ 1', coins: 1000 },
                { name: '–ò–≥—Ä–æ–∫ 2', coins: 800 },
                { name: '–í—ã', coins: userData.coins }
            ].sort((a, b) => b.coins - a.coins);
            simulatedRating.forEach((player, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${player.name} - ${player.coins} –º–æ–Ω–µ—Ç`;
                ratingList.appendChild(li);
            });
        }

        function buyCrystals(amount, price) {
            alert(`–î–ª—è –ø–æ–∫—É–ø–∫–∏ ${amount} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –∑–∞ ${price}‚ÇΩ, –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —á–µ–∫.`);
        }


        const marketItems = [
            { id: 1, resource: 'eggs', amount: 10, price: 5, seller: '–ò–≥—Ä–æ–∫ 1' },
            { id: 2, resource: 'wool', amount: 5, price: 10, seller: '–ò–≥—Ä–æ–∫ 2' }
        ];

        function updateMarketTab() {
            const marketItemsDiv = document.getElementById('market-items');
            marketItemsDiv.innerHTML = '';
            marketItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'market-item';
                div.innerHTML = `<p>${item.resource}: ${item.amount} –ø–æ ${item.price} –º–æ–Ω–µ—Ç (–ü—Ä–æ–¥–∞–≤–µ—Ü: ${item.seller})</p>
                    <button onclick="buyResource(${item.id})">–ö—É–ø–∏—Ç—å</button>`;
                marketItemsDiv.appendChild(div);
            });
        }

        function buyResource(itemId) {
            const item = marketItems.find(i => i.id === itemId);
            const totalCost = item.amount * item.price;
            if (userData.coins < totalCost) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç.');
                return;
            }
            const capacity = warehouseLevels[userData.warehouse_level - 1];
            const used = Object.values(userData.resources).reduce((sum, val) => sum + val, 0);
            const free = capacity - used;
            if (item.amount > free) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ.');
                return;
            }
            userData.coins -= totalCost;
            userData.resources[item.resource] += item.amount;
            saveUserData();
            updateCoinDisplay();
            updateWarehouseTab();
            alert(`–ö—É–ø–ª–µ–Ω–æ ${item.amount} ${item.resource} –∑–∞ ${totalCost} –º–æ–Ω–µ—Ç.`);
        }

        function getCropProductionTime(crop) {
            const productionTimes = {
                wheat: 1 * 60 * 60 * 1000, // 1 —á–∞—Å
                corn: 2 * 60 * 60 * 1000,  // 2 —á–∞—Å–∞
                carrot: 3 * 60 * 60 * 1000  // 3 —á–∞—Å–∞
            };
            return productionTimes[crop];
        }

        function getCropProductionCost(crop) {
            const productionCosts = {
                wheat: 10,
                corn: 20,
                carrot: 30
            };
            return productionCosts[crop];
        }

        document.querySelectorAll('.farm-tabs button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.farm-tabs button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const target = button.getAttribute('data-target');
                document.querySelectorAll('.farm-tab-content').forEach(tab => {
                    tab.style.display = tab.id === target ? 'block' : 'none';
                });
                if (target === 'animals-tab') {
                    updateAnimalsTab();
                } else if (target === 'crops-tab') {
                    updateCropsTab();
                }
            });
        });

        function startCropProduction(crop) {
            const cost = getCropProductionCost(crop);
            if (userData.coins < cost) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç.');
                return;
            }
            if (userData.production[crop].isProducing) {
                alert(`–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ ${crop} —É–∂–µ –∏–¥–µ—Ç.`);
                return;
            }
            userData.coins -= cost;
            userData.production[crop].startTime = Date.now();
            userData.production[crop].isProducing = true;
            saveUserData();
            updateCoinDisplay();
            updateCropsTab();
        }

        function updateCropsTab() {
            const cropsDiv = document.getElementById('crops');
            cropsDiv.innerHTML = '';
            const cropTypes = ['wheat', 'corn', 'carrot'];
            cropTypes.forEach(type => {
                const production = userData.production[type];
                let status = '';
                if (production.isProducing) {
                    const duration = getCropProductionTime(type);
                    const endTime = production.startTime + duration;
                    const currentTime = Date.now();
                    if (currentTime >= endTime) {
                        const amount = 10; // –ü—Ä–æ–∏–∑–≤–æ–¥–∏–º 10 –µ–¥–∏–Ω–∏—Ü
                        const capacity = warehouseLevels[userData.warehouse_level - 1];
                        const used = Object.values(userData.resources).reduce((sum, val) => sum + val, 0);
                        const free = capacity - used;
                        const toAdd = Math.min(amount, free);
                        userData.resources[type] += toAdd;
                        production.isProducing = false;
                        saveUserData();
                        status = `–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –î–æ–±–∞–≤–ª–µ–Ω–æ ${toAdd} ${type}.`;
                    } else {
                        const remaining = endTime - currentTime;
                        status = `–ò–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ... –û—Å—Ç–∞–ª–æ—Å—å: ${Math.ceil(remaining / 1000)} —Å–µ–∫—É–Ω–¥`;
                    }
                } else {
                    const cost = getCropProductionCost(type);
                    status = `<button onclick="startCropProduction('${type}')" ${userData.coins < cost ? 'disabled' : ''}>–ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ ${type} (—Å—Ç–æ–∏–º–æ—Å—Ç—å: ${cost} –º–æ–Ω–µ—Ç)</button>`;
                }
                const cropBlock = document.createElement('div');
                cropBlock.className = 'crop-block';
                cropBlock.innerHTML = `<p>${type.charAt(0).toUpperCase() + type.slice(1)}</p><p>${status}</p>`;
                cropsDiv.appendChild(cropBlock);
            });
        }

        setInterval(() => {
            if (document.getElementById('animals-tab').style.display === 'block') {
                updateAnimalsTab();
            } else if (document.getElementById('crops-tab').style.display === 'block') {
                updateCropsTab();
            }
        }, 1000);
    </script>
</body>
</html>